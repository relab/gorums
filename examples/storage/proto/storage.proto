edition = "2024";

package proto;
option go_package = "github.com/relab/gorums/examples/storage/proto";
option features.field_presence = IMPLICIT;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

import "gorums.proto";

// Storage is a simple key-value storage service
service Storage {
  // ReadRPC executes a Read RPC on a single node and
  // returns the value for the provided key.
  rpc ReadRPC(ReadRequest) returns (ReadResponse) {}

  // WriteRPC executes a Write RPC on a single node and
  // returns true if the value was updated.
  rpc WriteRPC(WriteRequest) returns (WriteResponse) {}

  // ReadQC executes a Read quorum call on a configuration of nodes and
  // returns the most recent value.
  rpc ReadQC(ReadRequest) returns (ReadResponse) {
    option (gorums.quorumcall) = true;
  }

  // WriteQC executes a Write quorum call on a configuration of nodes and
  // returns true if a majority of nodes were updated.
  rpc WriteQC(WriteRequest) returns (WriteResponse) {
    option (gorums.quorumcall) = true;
  }

  // WriteMulticast executes a Write multicast call on a configuration of nodes.
  // It does not wait for any responses.
  rpc WriteMulticast(WriteRequest) returns (google.protobuf.Empty) {
    option (gorums.multicast) = true;
  }
}

// ReadRequest is the request message for Read RPCs and Read quorum calls.
message ReadRequest {
  string key = 1;
}

// ReadResponse is the response message for Read RPCs and Read quorum calls.
message ReadResponse {
  bool                      ok    = 1;
  string                    value = 2;
  google.protobuf.Timestamp time  = 3;
}

// WriteRequest is the request message for Write RPCs, Write quorum calls, and Write multicast calls.
message WriteRequest {
  string                    key   = 1;
  string                    value = 2;
  google.protobuf.Timestamp time  = 3;
}

// WriteResponse is the response message for Write RPCs and Write quorum calls.
message WriteResponse {
  bool new = 1;
}
