# Available Options and Their Meaning

To select a call type for a Protobuf service method, you must specify one or more boolean options.
Gorums currently supports the following call types (these cannot be combined):

| Call type   | Gorums option        | Description                                                         |
| ----------- | -------------------- | ------------------------------------------------------------------- |
| Ordered RPC | no option            | FIFO-ordered synchronous RPC to a single node.                      |
| Unicast     | `gorums.unicast`     | FIFO-ordered one-way asynchronous unicast.                          |
| Multicast   | `gorums.multicast`   | FIFO-ordered one-way asynchronous multicast.                        |
| Quorum Call | `gorums.quorumcall`  | FIFO-ordered synchronous quorum call on a configuration of nodes.   |
| Correctable | `gorums.correctable` | Asynchronous quorum call with *incremental consistency guarantees*. |

All call types rely on a streaming RPC call named `NodeStream` to send and receive messages to/from individual nodes.
However, the server API generated by Gorums does not expose the gRPC stream-based API.
Instead, the generated API is similar to unary gRPC, except for the handling of return values is a bit different.

The quorum call call type may also specify the asynchronous option:

| Name         | Gorums option  | Type | Description                                                                                  |
| ------------ | -------------- | ---- | -------------------------------------------------------------------------------------------- |
| Asynchronous | `gorums.async` | bool | Makes the quorum call run asynchronously and returns a "promise" object to fetch the result. |

The correctable quorum call is an asynchronous call type that comes in two variants.
In the first variant, each node of the configuration sends only a single response.
In the second variant, each node may return multiple responses.
The second variant uses the gRPC server-side stream API and is indicated with the `stream` keyword associated with the return type.
See `ReadCorrectableStream` method below for an example.

Note that the `gorums.correctable` option should not be combined with the `gorums.async` option.

## Per-Node Transformations

For quorum calls and multicast/unicast, you can send different messages to each node using per-node transformation functions.
This is done at runtime using call options rather than proto options.

### QuorumCall with Per-Node Transform

```go
// Send different requests to each node
resp, err := cfg.Write(ctx, req, gorums.WithPerNodeTransform(
    func(req *WriteRequest, node *gorums.Node) *WriteRequest {
        // Customize request for each node based on node.ID() or other properties
        return &WriteRequest{Value: fmt.Sprintf("%s-node-%d", req.Value, node.ID())}
    },
))
```

### Multicast/Unicast with Per-Node Transform

```go
// Send different messages to each node in a multicast
cfg.WriteMulticast(ctx, msg, gorums.WithPerNodeTransform(
    func(msg *WriteMessage, node *gorums.Node) *WriteMessage {
        return &WriteMessage{Shard: node.ID()}
    },
))
```

If the transform function returns `nil`, the message will not be sent to that node,
effectively skipping it.

## Example Protobuf Definitions

Below is shown a list of RPC service methods, illustrating how to configure the different variants.

```proto
service Storage {
  // ReadOrdered is a FIFO-ordered RPC.
  rpc ReadOrdered(ReadRequest) returns (State) {}

  // ReadQC is a FIFO-ordered synchronous quorum call.
  rpc ReadQC(ReadRequest) returns (State) {
    option (gorums.quorumcall) = true;
  }

  // ReadAsync is an asynchronous quorum call that
  // returns a promise object for retrieving results.
  rpc ReadAsync(ReadRequest) returns (State) {
    option (gorums.async) = true;
    option (gorums.quorumcall) = true;
  }

  // ReadCorrectable is an asynchronous correctable quorum call that
  // returns a correctable object for retrieving results.
  rpc ReadCorrectable(ReadRequest) returns (State) {
    option (gorums.correctable) = true;
  }

  // ReadCorrectableStream is an asynchronous correctable quorum call that
  // returns a correctable object for retrieving results over a stream.
  rpc ReadCorrectableStream(ReadRequest) returns (stream State) {
    option (gorums.correctable) = true;
  }

  // WriteMulticast is an asynchronous multicast to all nodes in a configuration.
  // No replies are collected.
  rpc WriteMulticast(State) returns (Empty) {
    option (gorums.multicast) = true;
  }

  // Write is a synchronous quorum call.
  // Per-node transformations can be applied at runtime using WithPerNodeTransform.
  rpc Write(State) returns (WriteResponse) {
    option (gorums.quorumcall) = true;
  }
}
```

## Quorum Call Interceptors

Interceptors allow you to wrap quorum calls with additional behavior such as logging,
retries, or request/response modification. Interceptors are passed via the `WithQuorumInterceptors`
call option, similar to gRPC interceptors.

### Using Interceptors

```go
// Add interceptors to a quorum call
resp, err := cfg.Read(ctx, req,
    gorums.WithQuorumInterceptors(loggingInterceptor, retryInterceptor),
)
```

Multiple interceptors are executed in the order they are provided, wrapping the base
quorum function.

### Built-in Interceptors

Gorums provides several built-in interceptors:

- `PerNodeTransform`: Apply per-node request transformations
- `QuorumSpecInterceptor`: Wrap legacy QuorumSpec functions

### Custom Interceptors

You can create custom interceptors by implementing the `QuorumInterceptor` type:

```go
func myInterceptor[Req, Resp proto.Message, Out any](
    next gorums.QuorumFunc[Req, Resp, Out],
) gorums.QuorumFunc[Req, Resp, Out] {
    return func(ctx *gorums.ClientCtx[Req, Resp]) (Out, error) {
        // Pre-processing
        log.Println("Before quorum call")

        // Call the next handler in the chain
        result, err := next(ctx)

        // Post-processing
        log.Println("After quorum call")
        return result, err
    }
}
```
