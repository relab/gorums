# Developer Guide

The repository contains two main components:

* **dev:** the development code with a concrete (storage) implementation for
  testing. The folder also contains templates for dynamic code and all the
  static code that will be bundled together with the generated code.
* **plugins/gorums:** second order plugin to `protoc-gen-gorums` binary.

## Workflow and File Endings

1. Changes should be made to the development code in `dev`:
	* Changes to "dynamic" code, i.e. code that is dependent on protobuf
	  defintions, should by done by editing the respective `.tmpl` files.
	* Changes to "static" code, i.e. code that is **not** dependent on
	  protobuf definitions, should be done by editing the respective `.go`
	  files.

2. Any changes to dynamic or static code requires the invocation of `make dev`.
   This is to:
	* Copy the set of the templates and a static code bundle to the gorums
	  code generator plugin.
	* Update the `_gen.go` files in the `dev` directory.

See the Makefile for more details on the `dev` Makefile target.

The following file ending conventions are used in the `dev` package:

| File ending	| Description								|
|---------------|-----------------------------------------------------------------------|
| - `.tmpl`: 	| File is used by the gorums plugin to generate `_gen.go` files. 	|
| - `_gen.go`: 	| File is generated by the gorums plugin using `.tmpl` files.		|
| - `_udef.go`:	| File is user defined, e.g. a server implementation for testing. 	|
| - `_test.go`:	| File is a Go test file. 						|

These endings are important because all other files will be bundled together as
static resources during gorums code generation (see the
[bundle](https://github.com/relab/gorums/tree/master/cmd/bundle)) utility
program.

## Testing

All tests can be invoked by running ```make test``` and/or ```make testrace```.
There are two main tests for this project:

1. **dev/config_qc_test.go**: The integration tests in this package
   verifies that the concrete client/server storage implementation works.

2. **End-to-end**: This test invokes the generator with the ```storage.proto```
   example from ```dev``` and runs the integration tests against the
   *generated* code.

## Benchmarking

The ```benchcmp``` program is recommended for comparing benchmarks:

```shell
go get -u  golang.org/x/tools/cmd/benchcmp
```

Example :

```shell
git checkout devel (or another branch)
cd dev
go test . -run=$$ -bench=Read1KQ2N3Local -benchtime=3s -count=10 > old.txt
*make changes and regenerate _gen.go-files if needed*
go test . -run=$$ -bench=Read1KQ2N3Local -benchtime=3s -count=10 > new.txt
benchcmp old.txt new.txt
```

## Makefile

Below is a description of the current Makefile targets.
The Makefile itself also serves as documentation; inspect it for details.

| Target 		| Description 											|
|-----------------------|-----------------------------------------------------------------------------------------------|
| `all` 		| Run the `build` and `test` targets.								|
| `build` 		| Build all packages in the repository.								|
| `test` 		| Run all tests in the repository.								|
| `testrace` 		| Run all tests in the repository with the race detector enabled.				|
| `stresstestdev` 	| Run development test in a loop to catch sporadic failures.					|
| `benchlocal` 		| Run a set of benchmarks with servers running as part of the test binary.			|
| `benchremote` 	| Run a set of benchmarks that require separate running servers. See the benchmarks for details.|
| `clean` 		| Run `go clean` for the whole repository and remove all `.test` and `.prof` files. 		|
| `reinstallprotoc` 	| Install the `protoc-gen-gorums` binary with the gorums plugin included.			|
| `devproto` 		| Compile the development storage.proto file in the `dev` folder.				|
| `gorumsprotoopts` 	| Compile the gorums protobuf options from the `gorums.proto` file.				|
| `static` 		| Bundle the static (generic) code used by the gorums plugin.					|
| `templates` 		| Generate the templates code bundle used by the gorums plugin.					|
| `dev` 		| Generate _gen.go files for the `dev` folder. 							|
| `prof{cpu,mem,obj}` 	| Create a CPU/memory profile using a predefined benchmark. 					|
| `getdep` 		| Download the 'dep' vendoring tool.								|
| `getchecktools` 	| Download the static analysis tools.								|
| `getdevtools` 	| Download all development tools (`getdep` and `getchecktools`).				|
| `check` 		| Run a suite of static analysis tools.								|
| `updatedeps` 		| Update vendored dependencies to the latest version available. 				|
